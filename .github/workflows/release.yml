name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  SINGBOX_VERSION: "1.12.14"

jobs:
  build-and-upload:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: spider
            asset_name: spider-linux-amd64.tar.gz
            singbox_platform: linux-amd64
            singbox_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: spider.exe
            asset_name: spider-windows-amd64.zip
            singbox_platform: windows-amd64
            singbox_ext: zip
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: spider
            asset_name: spider-macos-amd64.tar.gz
            singbox_platform: darwin-amd64
            singbox_ext: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: spider
            asset_name: spider-macos-arm64.tar.gz
            singbox_platform: darwin-arm64
            singbox_ext: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Browser Stealth Script
        run: curl -L -o stealth.min.js https://raw.githubusercontent.com/requireCool/stealth.min.js/main/stealth.min.js

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Download sing-box
        shell: bash
        run: |
          echo "Downloading sing-box v${{ env.SINGBOX_VERSION }} for ${{ matrix.singbox_platform }}..."
          URL="https://github.com/SagerNet/sing-box/releases/download/v${{ env.SINGBOX_VERSION }}/sing-box-${{ env.SINGBOX_VERSION }}-${{ matrix.singbox_platform }}.${{ matrix.singbox_ext }}"
          echo "URL: $URL"
          curl -L -o sing-box-archive.${{ matrix.singbox_ext }} "$URL"
          
          mkdir -p sing-box-extracted
          if [ "${{ matrix.singbox_ext }}" == "zip" ]; then
            unzip -q sing-box-archive.zip -d sing-box-extracted
          else
            tar -xzf sing-box-archive.tar.gz -C sing-box-extracted
          fi
          
          # Find the binary (it's usually inside a folder named like the archive)
          find sing-box-extracted -name "sing-box*" -type f
          
          # Prepare bin directory
          mkdir -p staging/bin
          
          # Move binary to staging/bin (handle .exe extension for Windows)
          if [ "${{ runner.os }}" == "Windows" ]; then
             find sing-box-extracted -name "sing-box.exe" -exec cp {} staging/bin/ \;
          else
             find sing-box-extracted -name "sing-box" -type f -exec cp {} staging/bin/ \;
             chmod +x staging/bin/sing-box
          fi

      - name: Prepare Staging
        shell: bash
        run: |
          mkdir -p staging
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} staging/
          cp README.md staging/
          cp config.toml.example staging/

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd staging
          tar -czf ../${{ matrix.asset_name }} *

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          Compress-Archive -Path "staging/*" -DestinationPath ${{ matrix.asset_name }}

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.asset_name }}